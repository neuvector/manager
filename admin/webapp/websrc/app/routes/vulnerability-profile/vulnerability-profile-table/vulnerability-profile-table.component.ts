import {
  ChangeDetectorRef,
  Component,
  EventEmitter,
  Input,
  OnInit,
  Output,
  SimpleChanges,
  OnDestroy,
  OnChanges,
} from '@angular/core';
import {
  CfgType,
  RemoteExportOptionsWrapper,
  VulnerabilityProfileEntry,
} from '@common/types';
import { MatDialog } from '@angular/material/dialog';
import {
  ColDef,
  GridApi,
  GridOptions,
  GridReadyEvent,
  ValueFormatterParams,
} from 'ag-grid-community';
import { TranslateService } from '@ngx-translate/core';
import { VulnerabilityProfileTableEditCellComponent } from '@routes/vulnerability-profile/vulnerability-profile-table/vulnerability-profile-table-edit-cell/vulnerability-profile-table-edit-cell.component';
import { cloneDeep } from 'lodash';
import { VulnerabilityProfileTableDialogComponent } from '@routes/vulnerability-profile/vulnerability-profile-table/vulnerability-profile-table-dialog/vulnerability-profile-table-dialog.component';
import { ConfirmDialogComponent } from '@components/ui/confirm-dialog/confirm-dialog.component';
import { switchMap } from 'rxjs/operators';
import { VulnerabilityProfileService } from '@routes/vulnerability-profile/vulnerability-profile.service';
import { MultiClusterService } from '@services/multi-cluster.service';
import { Subject } from 'rxjs';
import { AuthUtilsService } from '@common/utils/auth.utils';
import { updateGridData } from '@common/utils/common.utils';
import { UtilsService } from '@common/utils/app.utils';
import { NotificationService } from '@services/notification.service';
import { saveAs } from 'file-saver';
import { PathConstant } from '@common/constants/path.constant';
import { VulnerabilityProfileTableImportDialogComponent } from './vulnerability-profile-table-import-dialog/vulnerability-profile-table-import-dialog.component';
import { GlobalConstant } from '@common/constants/global.constant';
import { MapConstant } from '@common/constants/map.constant';
import { ExportOptionsModalComponent } from '@components/export-options-modal/export-options-modal.component';
import { DomSanitizer, SafeHtml } from '@angular/platform-browser';


@Component({
  standalone: false,
  selector: 'app-vulnerability-profile-table',
  templateUrl: './vulnerability-profile-table.component.html',
  styleUrls: ['./vulnerability-profile-table.component.scss'],
  
})
export class VulnerabilityProfileTableComponent
  implements OnInit, OnDestroy, OnChanges
{
  private serverErrorMessage: SafeHtml = '';
  private _switchClusterSubscription;
  private _rowData!: VulnerabilityProfileEntry[];
  @Input() set rowData(data: VulnerabilityProfileEntry[]) {
    this._rowData = data;
    this.refreshing$.next(false);
  }
  get rowData() {
    return this._rowData;
  }
  @Input() gridHeight!: number;
  @Input() domains!: string[];
  @Input() cfgType!: CfgType;
  get cfgTypeClass() {
    let cfgType = (
      this.cfgType ? this.cfgType : GlobalConstant.CFG_TYPE.CUSTOMER
    ).toUpperCase();
    return MapConstant.colourMap[cfgType];
  }
  refreshing$ = new Subject();
  filtered: boolean = false;
  filteredCount!: number;
  @Output() toggleChartView = new EventEmitter();
  gridOptions!: GridOptions;
  gridApi!: GridApi;
  columnDefs: ColDef[] = [
    {
      field: 'id',
      sortable: true,
      resizable: true,
      width: 100,
      headerValueGetter: () => this.translate.instant('general.ID'),
    },
    {
      field: 'name',
      sortable: true,
      resizable: true,
      wrapText: true,
      autoHeight: true,
      valueFormatter: this.nameFormatter.bind(this),
      headerValueGetter: () =>
        this.translate.instant('cveProfile.gridHeader.VULNERABILITY_FILTER'),
    },
    {
      field: 'images',
      sortable: true,
      resizable: true,
      headerValueGetter: () =>
        this.translate.instant('cveProfile.gridHeader.IMAGES'),
    },
    {
      field: 'domains',
      sortable: true,
      resizable: true,
      headerValueGetter: () =>
        this.translate.instant('cveProfile.gridHeader.DOMAINS'),
    },
    {
      width: 250,
      field: 'comment',
      sortable: true,
      resizable: true,
      wrapText: true,
      autoHeight: true,
      headerValueGetter: () =>
        this.translate.instant('cveProfile.gridHeader.COMMENT'),
    },
    {
      field: 'controls',
      width: 100,
      cellRenderer: 'editCellRenderer',
      cellRendererParams: {
        edit: event => this.editProfile(event),
        delete: event => this.deleteProfile(event),
      },
      cellClass: ['d-flex', 'align-items-center'],
      headerValueGetter: () => '',
    },
  ];

  constructor(
    private translate: TranslateService,
    private vulnerabilityProfileService: VulnerabilityProfileService,
    private multiClusterService: MultiClusterService,
    private cd: ChangeDetectorRef,
    public dialog: MatDialog,
    private authUtilsService: AuthUtilsService,
    private utils: UtilsService,
    private notificationService: NotificationService,
    private domSanitizer: DomSanitizer
  ) {}

  ngOnInit(): void {
    let isWriteVulsProfileAuthorizaed =
      this.authUtilsService.getDisplayFlag('write_vuls_profile');
    this.filteredCount = this.rowData.length;
    if (!isWriteVulsProfileAuthorizaed || this.cfgType === 'ground') {
      this.columnDefs.pop();
    }
    this.gridOptions = {
      rowData: this.rowData,
      columnDefs: this.columnDefs,
      suppressDragLeaveHidesColumns: true,
      rowSelection: 'single',
      onGridReady: event => this.onGridReady(event),
      components: {
        editCellRenderer: VulnerabilityProfileTableEditCellComponent,
      },
      overlayNoRowsTemplate: this.translate.instant('general.NO_ROWS'),
    };

    //refresh the page when it switched to a remote cluster
    this._switchClusterSubscription =
      this.multiClusterService.onClusterSwitchedEvent$.subscribe(data => {
        this.refresh();
      });
  }

  ngOnDestroy(): void {
    if (this._switchClusterSubscription) {
      this._switchClusterSubscription.unsubscribe();
    }
  }

  ngOnChanges(changes: SimpleChanges): void {
    if (this.gridApi && changes.rowData) {
      this.gridApi.setGridOption('rowData', changes.rowData.currentValue);
    }
  }

  nameFormatter(params: ValueFormatterParams) {
    console.log(params.node?.data);
    if (params.node?.data.name === '_RecentVulnWithoutFix') {
      return this.translate.instant(
        'cveProfile.gridHeader.REPORTED_DAYS_WITHOUT_FIX',
        {
          days: params.data.days,
        }
      );
    } else if (params.node?.data.name === '_RecentVuln') {
      return this.translate.instant('cveProfile.gridHeader.REPORTED_DAYS', {
        days: params.data.days,
      });
    } else {
      return params.value;
    }
  }

  refresh() {
    this.refreshing$.next(true);
    this.vulnerabilityProfileService.refresh();
  }

  onGridReady(params: GridReadyEvent): void {
    this.gridApi = params.api;
    this.gridApi.sizeColumnsToFit();
    this.gridApi.forEachNode(node =>
      node.rowIndex ? 0 : node.setSelected(true)
    );
    this.cd.markForCheck();
  }

  onResize(): void {
    this.gridApi.sizeColumnsToFit();
  }

  addProfile() {
    this.openDialog();
  }

  editProfile(event): void {
    this.openDialog(cloneDeep(this.gridApi.getRowNode(event.node.id)?.data));
  }

  deleteProfile(event): void {
    let id = this.gridApi.getRowNode(event.node.id)?.data.id;
    const dialogRef = this.dialog.open(ConfirmDialogComponent, {
      maxWidth: '700px',
      data: {
        message: this.translate.instant('role.msg.REMOVE_CFM'),
      },
    });
    dialogRef.componentInstance.confirm
      .pipe(
        switchMap(() => {
          let name = 'default';
          return this.vulnerabilityProfileService.deleteProfile(name, id);
        })
      )
      .subscribe(
        res => {
          updateGridData(
            this.rowData,
            [{ id: id }],
            this.gridApi,
            'id',
            'delete'
          );
          dialogRef.componentInstance.onCancel();
          dialogRef.componentInstance.loading = false;
        },
        error => {}
      );
  }

  openDialog(profile?): void {
    const dialog = this.dialog.open(VulnerabilityProfileTableDialogComponent, {
      width: '80%',
      maxWidth: '1100px',
      data: {
        profile,
        domains: this.domains,
        gridApi: this.gridApi,
        rowData: this.rowData,
      },
    });
    dialog.afterClosed().subscribe(change => {
      if (change) {
        if (!profile) {
          setTimeout(() => {
            this.vulnerabilityProfileService.refresh();
          }, 1000);
        }
      }
      this.cd.markForCheck();
    });
  }

  filterCountChanged(results: number) {
    this.filteredCount = results;
    this.filtered = this.filteredCount !== this.rowData.length;
  }

  exportProfile(): void {
    const dialogRef = this.dialog.open(ExportOptionsModalComponent, {
      width: '50%',
      disableClose: true,
      data: {},
    });

    dialogRef.afterClosed().subscribe((result: RemoteExportOptionsWrapper) => {
      if (result) {
        const { export_mode, ...exportOptions } = result.export_options;
        this.exportUtil(export_mode, exportOptions);
      }
    });
  }

  exportUtil(mode: string, option: any) {
    if (mode === 'local') {
      let payload = { names: ['default'] };
      this.vulnerabilityProfileService.exportProfile(payload).subscribe(
        response => {
          let fileName = this.utils.getExportedFileName(response);
          let blob = new Blob([response.body || ''], {
            type: 'text/plain;charset=utf-8',
          });
          saveAs(blob, fileName);
          this.notificationService.open(
            this.translate.instant('cveProfile.msg.EXPORT_PROFILE_OK')
          );
        },
        error => {
          this.notificationService.openError(
            error.error,
            this.translate.instant('cveProfile.msg.EXPORT_PROFILE_NG')
          );
        }
      );
    } else if (mode === 'remote') {
      let payload = {
        names: ['default'],
        remote_export_options: option,
      };
      this.vulnerabilityProfileService.exportProfile(payload).subscribe(
        response => {
          const responseObj = JSON.parse(response.body as string);
          this.notificationService.open(
            `${this.translate.instant(
              'cveProfile.msg.EXPORT_PROFILE_OK'
            )} ${this.translate.instant('general.EXPORT_FILE')} ${
              responseObj.file_path
            }`
          );
        },
        error => {
          if (
            error.message &&
            error.message.length > GlobalConstant.MAX_ERROR_MESSAGE_LENGTH
          ) {
            this.serverErrorMessage = this.domSanitizer.bypassSecurityTrustHtml(
              error.message
            );
          }

          this.notificationService.open(
            this.serverErrorMessage
              ? this.translate.instant('cveProfile.msg.EXPORT_PROFILE_NG')
              : this.utils.getAlertifyMsg(error, '', false),
            GlobalConstant.NOTIFICATION_TYPE.ERROR
          );
        }
      );
    } else {
      return;
    }
  }

  openImportProfileModal(): void {
    const importDialogRef = this.dialog.open(
      VulnerabilityProfileTableImportDialogComponent,
      {
        data: {
          importUrl: PathConstant.IMPORT_CVE_PROFILE,
          importMsg: {
            success: this.translate.instant('cveProfile.msg.IMPORT_FINISH'),
            error: this.translate.instant('cveProfile.msg.IMPORT_FAILED'),
          },
        },
      }
    );
    importDialogRef.afterClosed().subscribe(result => {
      setTimeout(() => {
        this.refresh();
      }, 500);
    });
  }
}
